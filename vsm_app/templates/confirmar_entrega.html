{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmar Entrega</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../static/css/default-colors.css">
  <style>
    :root {
      --fondo-oscuro: rgb(24, 24, 24);
      --detalle-dorado: rgb(106, 89, 45);
      --bg-secondary: rgb(12, 12, 12);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .toast-container::after{
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      content: '';
      background: rgba(0, 0, 0, 0.5);
      border-radius: 0.5rem;
      animation: fadeIn 0.3s ease-out forwards;
    }
  </style>
  <script src="https://unpkg.com/onscan.js/onscan.min.js"></script>
</head>

<body class="min-h-screen bg-[var(--fondo-oscuro)] flex flex-col items-center px-4 py-6">

  <div class="w-full my-auto  max-w-3xl sm:max-w-4xl md:max-w-5xl min-h-3xl sm:min-h-4xl md:min-h-5xl bg-[var(--bg-secondary)] p-6 sm:p-10 md:p-16 rounded-2xl shadow-xl border border-[var(--detalle-dorado)] text-white">
    <h1 class="text-3xl font-semibold text-center text-[var(--detalle-dorado)] mb-6">Confirmar Entrega de VSM</h1>

    <form action="{% url 'confirmar_entrega' vsm.id %}" method="post" class="space-y-4" id="formEntrega">
      {% csrf_token %}
      
      <div class="grid grid-cols-2 gap-4">
        <p><span class="text-[var(--detalle-dorado)] font-medium">Solicitante:</span> {{ vsm.solicitante }}</p>
        <p><span class="text-[var(--detalle-dorado)] font-medium">Retirante:</span> {{ vsm.retirante }}</p>
      </div>

      <table class="w-full text-sm border border-gray-600 rounded-lg overflow-hidden">
        <thead class="bg-neutral-800 text-gold" style="color: var(--detalle-dorado);">
          <tr>
            <th class="text-left px-4 py-2">Producto</th>
            <th class="text-left px-4 py-2">Cantidad Solicitada</th>
            <th class="text-center px-4 py-2">Cantidad Entregada</th>
          </tr>
        </thead>
        <tbody>
          {% for vsm_producto in vsm.vsmproducto_set.all %}
          <tr class="border-b border-gray-700">
            <td class="px-4 py-3">{{ vsm_producto.producto }}</td>
            <td class="px-4 py-3 text-center">{{ vsm_producto.cantidad_solicitada }}</td>
            {% if vsm.estado == "pendiente" %}
            <td class="px-4 py-3 text-center">
              <input type="number" 
                     name="cantidad_entregada_{{ vsm_producto.id }}" 
                     value="{{ vsm_producto.cantidad_entregada }}"
                     min="0" 
                     max="{{ vsm_producto.cantidad_solicitada }}" 
                     class="w-24 bg-zinc-800 border border-zinc-700 rounded-xl px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-[var(--detalle-dorado)]"
                     id="cantEntregada">
                     
            </td>
            {% else %}
            <td class="px-4 py-3">{{ vsm_producto.cantidad_entregada }}</td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div>
        <label for="observaciones_entrega" class="block text-sm font-medium text-[var(--detalle-dorado)] mb-1">Observaciones</label>
        <textarea name="observaciones_entrega" id="observaciones_entrega" rows="4" class="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-[var(--detalle-dorado)]"></textarea>
      </div>

      <div class="flex items-center gap-4">
        {% if vsm.estado == "pendiente" %}
        <button type="button" id="btnAbrirModal"
                class="bg-[var(--detalle-dorado)] hover:bg-yellow-700 transition px-6 py-2 rounded-xl font-medium text-sm">
          Confirmar Entrega
        </button>

        <a href="{% url 'rechazar_entrega' vsm.id %}">
          <button type="button" id="btnRechazar" class="bg-red-600 hover:bg-red-700 transition px-6 py-2 rounded-xl font-medium text-sm">
            Rechazar entrega
          </button>
        </a>
        {% endif %}

        <a href="{% url 'listar_vsm_pendientes' %}" class="text-sm text-[var(--detalle-dorado)] hover:underline">
          Volver a Vales Pendientes
        </a>
      </div>
    </form>
  </div>
<div id="modalRFID" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-[var(--fondo-oscuro)] p-6 rounded-2xl shadow-lg w-96 text-center border border-[var(--detalle-dorado)]">
    <h2 class="text-lg font-semibold text-white mb-4">Confirmar Retiro</h2>
    <p class="text-gray-300 mb-6">Por favor, apoye la tarjeta del retirante en el lector para continuar.</p>
    <div class="flex justify-center space-x-4">
      <button id="btnCancelarRFID"
              class="px-4 py-2 rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
        Cancelar
      </button>
    </div>
  </div>
</div>

  <!-- Toast -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>
  <!-- End Toast -->


<script>
document.addEventListener('DOMContentLoaded', function () {
  const forms = document.querySelectorAll('form');

  forms.forEach(form => {
    form.addEventListener('keydown', function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
  });
});
</script>

<script src="https://unpkg.com/onscan.js/onscan.min.js"></script>
<script>
const btnAbrirModal = document.getElementById("btnAbrirModal");
const btnCancelarRFID = document.getElementById("btnCancelarRFID");
const modalRFID = document.getElementById("modalRFID");
const form = document.getElementById("formEntrega");
const tarjetasEsperadas = {{ tarjetas_json|safe }};

let esperandoScan = false;

btnAbrirModal.addEventListener("click", () => {
  modalRFID.classList.remove("hidden");
  esperandoScan = true;
});

btnCancelarRFID.addEventListener("click", () => {
  modalRFID.classList.add("hidden");
  esperandoScan = false;
});

onScan.attachTo(document, {
  suffixKeyCodes: [13],
  reactToPaste: true,
  onScan: function (scannedCode) {
    console.log("Código escaneado:", scannedCode);
    console.log("Tarjetas válidas:", tarjetasEsperadas);

    if (esperandoScan) {
      if (tarjetasEsperadas.includes(scannedCode)) {
        modalRFID.classList.add("hidden");

        const formData = new FormData(form);

        fetch(form.action, {
          method: "POST",
          body: formData,
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast("Entrega guardada correctamente ✅", "success");
            btnAbrirModal.disabled = true;

            document.getElementById("btnAbrirModal").disabled = true;
            document.getElementById("btnAbrirModal").hidden = true;
            document.getElementById("btnRechazar").disabled = true;
            document.getElementById("btnRechazar").hidden = true;

            document.getElementById("cantEntregada").disabled = true;

            document.getElementById("btnAbrirModal").classList.add("opacity-50", "cursor-not-allowed");
            document.getElementById("btnRechazar").classList.add("opacity-50", "cursor-not-allowed");
          } else {
            showToast("Error al guardar entrega ❌", "error");
          }
        })
        .catch(() => showToast("Error de conexión ❌", "error"));
      } else {
        showToast("Acceso denegado ❌", "error");
      }
      esperandoScan = false;
    }
  }
});
</script>

<script>
  function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");

    // Crear div del toast
    const toast = document.createElement("div");
    toast.className = `px-4 py-2 rounded-lg shadow-lg text-white 
      ${type === "success" ? "bg-green-600" : "bg-red-600"} 
      animate-fadeIn`;

    toast.innerText = message;

    container.appendChild(toast);

    // Desaparecer después de 3s
    setTimeout(() => {
      toast.classList.add("animate-fadeOut");
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }
</script>

</body>
</html>
