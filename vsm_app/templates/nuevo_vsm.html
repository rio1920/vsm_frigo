<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nuevo VSM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<style>
  :root {
    --fondo-oscuro: rgb(24, 24, 24);
    --detalle-dorado: rgb(106, 89, 45);
  }
  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast-container::after{
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    content: '';
    background: rgba(0, 0, 0, 0.5);
    border-radius: 0.5rem;
    animation: fadeIn 0.3s ease-out forwards;
  }

  .select2-container--default .select2-selection--single {
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 0.25rem;
    padding: 0.5rem;
    height: 3rem;
  }
  
</style>
<link rel="stylesheet" href="../static/css/default-colors.css">
<body class="bg-darkmode">

    {% if error %}
      <div class="bg-red-100 text-red-700 p-2 mb-4 rounded">{{ error }}</div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}

    <div class="max-w-xl sm:max-w-2xl md:max-w-3xl lg:max-w-4xl mx-auto mt-12 p-6 rounded-xl shadow-lg bg-card-darkmode text-gold">

      <form method="POST" class="space-y-6">
        {% csrf_token %}

        <!-- Tipo de entrega y facturaci√≥n -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold mb-1">Tipo de entrega</label>
            <select id="tipo_entrega" name="tipo_entrega" class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black">
              <option value="INSUMOS" selected>Insumos</option>
              <option value="EPP">EPP</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold mb-1">Tipo de facturaci√≥n</label>
            <select id="tipo_facturacion" name="tipo_facturacion" class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black">
              <option value="NO_FACTURADO" selected>No facturado</option>
              <option value="FACTURADO">Facturado</option>
            </select>
          </div>
        </div>

        <!-- Solicitante -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Solicitante</label>
          <input type="text" value="{{ usuario_logeado }}" readonly
            class="w-full rounded-lg border border-gray-600 p-2 bg-gray-100 text-black cursor-not-allowed">
          <input type="hidden" name="solicitante" value="{{ user.id }}">
        </div>

        <!-- Centro de costos -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Centro de costos</label>
          <select id="centro_costos" name="centro_costos" class="w-full select2">
            <option value="">Seleccione un centro de costos...</option>
            {% for centro in centro_usuario %}
              <option value="{{ centro.id }}">{{ centro.codigo }} - {{ centro.descripcion }}</option>
            {% endfor %}
          </select>
          <input type="hidden" id="hidden_centro_costos" name="centro_costos">
        </div>

        <!-- Retirante -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Retirante</label>
          <select id="retirante" name="retirante" class="w-full select2">
            <option value="">Seleccione un retirante...</option>
          </select>
          <input type="hidden" id="hidden_retirante" name="retirante">
        </div>

        <!-- Observaciones -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Observaciones</label>
          <textarea name="detalles" rows="3" class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black"></textarea>
        </div>

        <!-- Buscar producto -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Buscar producto</label>
          <div class="flex flex-col sm:flex-row gap-3">
            <select id="select-producto" class="flex-1 select2" disabled>
              <option value="">Escriba para buscar...</option>
            </select>
            <input type="number" id="cantidad-producto" min="1"
              class="w-28 rounded-lg border border-gray-600 p-2 text-black" placeholder="Cantidad">
            <button type="button" onclick="agregarProductoDesdeSelect()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
              Agregar
            </button>
          </div>
        </div>

        <!-- Tabla productos -->
        <div class="mt-2">
          <table id="tabla-productos" class="w-full text-sm border border-gray-600 rounded-lg overflow-hidden">
            <thead class="bg-neutral-800 text-gold">
              <tr>
                <th class="p-2 text-left">Producto</th>
                <th class="p-2 text-center">Cantidad</th>
                <th class="p-2 text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700"></tbody>
          </table>
        </div>

        <!-- Botones -->
        <div class="flex justify-between items-center pt-6">
          <a href="{% url 'home' %}" class="px-4 py-2 border border-[rgb(106,89,45)] text-gold rounded-lg hover:bg-neutral-800">
            ‚Üê Volver
          </a>
          <button type="submit" class="bg-green-600 px-6 py-2 text-white rounded-lg hover:bg-green-700">
            Realizar VSM
          </button>
        </div>
      </form>
    </div>

  <!-- Contenedor para toasts -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>


<script>
  $(document).ready(function () {
    $('.select2').select2();

    const $productos = $('#select-producto');
    const $retirante = $('#retirante');
    const $centro = $('#centro_costos');

    // Al iniciar: deshabilitar productos si no hay centro seleccionado
    if (!$centro.val()) {
      $productos.prop('disabled', true);
    }

    // === 1. Al cambiar el centro de costo ===
    $centro.on('change', function () {
      const centroId = $(this).val();

      // --- limpiar retirante ---
      $retirante.empty().append('<option value="">Cargando...</option>');

      if (centroId) {
        // Cargar empleados asociados al centro
        $.ajax({
          url: '{% url "obtener_empleados_por_centro" %}',
          data: { centro_id: centroId },
          success: function (data) {
            $retirante.empty().append('<option value="">Seleccione un retirante...</option>');
            data.empleados.forEach(emp => {
              const label = `${emp.legajo}, ${emp.nombre}`;
              $retirante.append(new Option(label, emp.id));
            });
          },
          error: function () {
            $retirante.empty().append('<option value="">Error al cargar empleados</option>');
          }
        });

        // habilitar productos
        $productos.prop('disabled', false);

      } else {
        $retirante.empty().append('<option value="">Seleccione un centro primero</option>');
        $productos.val(null).trigger('change');
        $productos.prop('disabled', true);
      }
    });

  // === 2. Productos din√°micos seg√∫n centro de costo y tipo de entrega ===
  $productos.select2({
    placeholder: 'Buscar producto...',
    ajax: {
      url: '{% url "buscar_productos_por_centro" %}',
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          q: params.term,
          centro_costo: $centro.val(),   // üëà centro seleccionado
          tipo_entrega: $('#tipo_entrega').val() // üëà nuevo select para EPP o insumos
        };
      },
      processResults: function (data) {
        return { results: data.results };
      },
      cache: true
    },
    minimumInputLength: 0
  });

  // üîÑ refrescar productos cuando cambie el tipo_entrega
  $('#tipo_entrega').on('change', function () {
    $productos.val(null).trigger('change'); // limpia selecci√≥n
  });

  });

  function bloquearSelects() {
      const centroSelect = document.getElementById('centro_costos');
      const retiranteSelect = document.getElementById('retirante');

      // pasar valores a los hidden
      document.getElementById('hidden_centro_costos').value = centroSelect.value;
      document.getElementById('hidden_retirante').value = retiranteSelect.value;

      // quitar name para que no se mande duplicado
      centroSelect.removeAttribute("name");
      retiranteSelect.removeAttribute("name");

      // bloquear selects
      centroSelect.disabled = true;
      retiranteSelect.disabled = true;
  }

  function desbloquearSelects() {
    const centro = document.getElementById("centro_costos");
    const retirante = document.getElementById("retirante");

    centro.removeAttribute("disabled");
    retirante.removeAttribute("disabled");

    // Remove hidden inputs if present
    const hiddenCentro = document.getElementById("hidden-centro-costos");
    if (hiddenCentro) hiddenCentro.remove();
    const hiddenRetirante = document.getElementById("hidden-retirante");
    if (hiddenRetirante) hiddenRetirante.remove();
  }

  function agregarProductoDesdeSelect() {
    const centroId = $('#centro_costos').val();
    const select = $('#select-producto');
    const productoId = select.val();
    const productoDesc = select.find("option:selected").text();
    const cantidad = $('#cantidad-producto').val();

    if (!centroId) {
      alert('Deb√©s seleccionar un centro de costo antes de elegir materiales.');
      return;
    }

    if (!productoId || !cantidad || cantidad <= 0) {
      alert('Deb√©s seleccionar un producto y una cantidad v√°lida.');
      return;
    }

    if (document.getElementById(`fila_${productoId}`)) {
      alert('Este producto ya fue agregado.');
      return;
    }

    const fila = `
      <tr id="fila_${productoId}">
        <td class="p-2">${productoDesc}</td>
        <td class="p-2 text-center">${cantidad}</td>
        <td class="p-2 text-center">
          <input type="hidden" name="producto_${productoId}" value="${cantidad}">
          <button type="button" onclick="eliminarProducto('${productoId}')" class="text-red-600 hover:underline">Eliminar</button>
        </td>
      </tr>
    `;

    document.querySelector('#tabla-productos tbody').insertAdjacentHTML('beforeend', fila);
    showSuccessToast("Producto agregado correctamente ‚úÖ", "success");

    bloquearSelects();

    $('#select-producto').val(null).trigger('change');
    $('#cantidad-producto').val('');
  }

  function eliminarProducto(id) {
    showSuccessToast("Producto eliminado correctamente ‚úÖ", "success");
    document.getElementById(`fila_${id}`).remove();

    if (document.querySelectorAll('#tabla-productos tbody tr').length === 0) {
      desbloquearSelects();
    }
  }
</script>

<script>
function showSuccessToast(message, type = "success") {
  const container = document.getElementById("toast-container");

  // Crear div del toast
  const toast = document.createElement("div");
  toast.className = `px-8 py-4 rounded-lg shadow-lg text-white 
    ${type === "success" ? "bg-green-600" : "bg-red-600"} 
    animate-fadeIn`;

  toast.innerText = message;

  container.appendChild(toast);

  // Desaparecer despu√©s de 3s
  setTimeout(() => {
    toast.classList.add("animate-fadeOut");
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

function showErrorToast(message, type = "error") {
  const container = document.getElementById("toast-container");

  // Crear div del toast  
  const toast = document.createElement("div");
  toast.className = `px-8 py-4 rounded-lg shadow-lg text-white 
    ${type === "success" ? "bg-red-600" : "bg-red-600"} 
    animate-fadeIn`;

  toast.innerText = message;

  container.appendChild(toast);

  // Desaparecer despu√©s de 3s
  setTimeout(() => {
    toast.classList.add("animate-fadeOut");
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const centroCostosSelect = document.getElementById("centro_costos");
  const empleadosSelect = document.getElementById("empleados");
  const tablaProductos = document.getElementById("tabla_productos").querySelector("tbody");

  function bloquearSelects() {
    centroCostosSelect.disabled = true;
    empleadosSelect.disabled = true;
  }

  function desbloquearSelects() {
    centroCostosSelect.disabled = false;
    empleadosSelect.disabled = false;
  }

  // üëá Cada vez que cambie la tabla revisamos si hay productos
  const observer = new MutationObserver(() => {
    if (tablaProductos.children.length > 0) {
      bloquearSelects();
    } else {
      desbloquearSelects();
    }
  });

  observer.observe(tablaProductos, { childList: true, subtree: false });
});
</script>


</body>
</html>
