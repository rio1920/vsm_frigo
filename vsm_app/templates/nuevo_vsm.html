{% extends 'base.html' %}
{% load static %}
{% block title %}Nuevo VSM - VSM{% endblock %}
{% block content %}

{% include 'navbar.html' %}
<style>
  :root {
    --fondo-oscuro: rgb(24, 24, 24);
    --detalle-dorado: rgb(106, 89, 45);
  }

  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast-container::after {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    content: '';
    background: rgba(0, 0, 0, 0.5);
    border-radius: 0.5rem;
    animation: fadeIn 0.3s ease-out forwards;
  }

  .select2-container--default .select2-selection--single {
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 0.25rem;
    padding: 0.5rem;
    height: 3rem;
  }

  .select2 span {
    background-color: white;
    color: black !important;
  }

  span {
    color: black;
  }

  /* ul li{
    color: black;
  } */

  .alert-error {
    background-color: #f87171;
    /* rojo */
    color: white;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
  }
</style>

<body>

  {% if error %}
  <div class="bg-red-100 text-red-700 p-2 mb-4 rounded">{{ error }}</div>
  {% endif %}

  <form method="POST">
    {% csrf_token %}

    <div
      class="bg-base-300 sm:max-w-2xl md:max-w-3xl lg:max-w-4xl mx-auto mt-12 p-6 rounded-xl shadow-lg bg-card-darkmode text-gold">

      <form method="POST" class="space-y-6">
        {% csrf_token %}

        <!-- Tipo de entrega y facturaci√≥n -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold mb-1">Tipo de entrega</label>
            <select id="tipo_entrega" name="tipo_entrega_select"
              class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black">
              <option value="INSUMOS" selected>Insumos</option>
              <option value="EPP">EPP</option>
            </select>
            <input type="hidden" id="hidden_tipo_entrega" name="tipo_entrega">
          </div>
          <div>
            <label class="block font-semibold mb-1">Tipo de facturaci√≥n</label>
            <select id="tipo_facturacion" name="tipo_facturacion_select"
              class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black">
              <option value="NO_FACTURADO" selected>No facturado</option>
              <option value="FACTURADO">Facturado</option>
            </select>
            <input type="hidden" id="hidden_tipo_facturacion" name="tipo_facturacion">
          </div>
        </div>

        <!-- Solicitante -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Solicitante</label>
          <input type="text" value="{{ usuario_logeado }}" readonly
            class="w-full rounded-lg border border-gray-600 p-2 bg-gray-100 text-black cursor-not-allowed">
          <input type="hidden" name="solicitante" value="{{ user.id }}">
        </div>

        <!-- Centro de costos -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Centro de costos</label>
          <select id="centro_costos" name="centro_costos" class="w-full select2">
            <option value="">Seleccione un centro de costos...</option>
            {% for centro in centro_usuario %}
            <option value="{{ centro.id }}" class="text-black">{{ centro.codigo }} - {{ centro.descripcion }}</option>
            {% endfor %}
          </select>
          <input type="hidden" id="hidden_centro_costos" name="centro_costos">
        </div>

        <!-- Retirante -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Retirante</label>
          <select id="retirante" name="retirante" class="w-full select2">
            <option value="">Seleccione un retirante...</option>
          </select>
          <input type="hidden" id="hidden_retirante" name="retirante">
        </div>

        <!-- Observaciones -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Observaciones</label>
          <textarea name="detalles" rows="3"
            class="w-full rounded-lg border border-gray-600 p-2 bg-white text-black"></textarea>
        </div>

        <!-- Buscar producto -->
        <div class="mt-2">
          <label class="block font-semibold mb-1">Buscar producto</label>
          <div class="flex flex-col sm:flex-row gap-3">
            <select id="select-producto" class="flex-1 select2" disabled>
              <option value="">Escriba para buscar...</option>
            </select>
            <input type="number" id="cantidad-producto" min="1"
              class="w-28 rounded-lg border border-gray-600 p-2 bg-white text-black" placeholder="Cantidad">
            <button type="button" onclick="agregarProductoDesdeSelect()" class="px-4 py-2 rounded-lg btn border bg-secondary">
              Agregar
            </button>
          </div>
        </div>

        <!-- Contenedor para tags -->
        <div id="tags_container" class="mt-3">
          <div id="tags_list" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Tabla productos -->
        <div class="mt-2">
          <table id="tabla-productos" class="w-full text-sm border border-gray-600 rounded-lg overflow-hidden">
            <thead>
              <tr>
                <th class="p-2 text-left">Producto</th>
                <th class="p-2 text-center">Cantidad</th>
                <th class="p-2 text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700"></tbody>
          </table>
        </div>

        <!-- Botones -->
        <div class="flex justify-between items-center pt-6">
          <a href="{% url 'home' %}" class="px-4 py-2 btn text-gold rounded-lg bg-secondary">
            ‚Üê Volver
          </a>
          <button type="submit" class="bg-primary px-6 py-2 rounded-lg">
            Realizar VSM
          </button>
        </div>
      </form>
    </div>

    <!-- Contenedor para toasts -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}


    {% block scripts %}
    <script>
      document.getElementById("retirante").addEventListener("change", function () {
        const retiranteId = this.value;
        const tipoEntrega = document.getElementById("tipo_entrega").value;

        if (retiranteId && tipoEntrega === "EPP") {
          fetch(`/empleados/${retiranteId}/tags/`)
            .then(res => res.json())
            .then(data => {
              const container = document.getElementById("tagsContainer");
              container.innerHTML = ""; // limpiar

              if (data.tags.length > 0) {
                data.tags.forEach(tag => {
                  const span = document.createElement("span");
                  span.textContent = tag;
                  span.className = "px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-sm";
                  container.appendChild(span);
                });

                document.getElementById("tagsRecomendados").classList.remove("hidden");
              } else {
                document.getElementById("tagsRecomendados").classList.add("hidden");
              }
            })
            .catch(err => console.error("Error cargando tags:", err));
        } else {
          document.getElementById("tagsRecomendados").classList.add("hidden");
        }
      });
    </script>

    <script>
      $(document).ready(function () {
        $('.select2').select2();

        const $productos = $('#select-producto');
        const $retirante = $('#retirante');
        const $centro = $('#centro_costos');

        // Al iniciar: deshabilitar productos si no hay centro seleccionado
        if (!$centro.val()) {
          $productos.prop('disabled', true);
        }

        // === 1. Al cambiar el centro de costo ===
        $centro.on('change', function () {
          const centroId = $(this).val();

          // --- limpiar retirante ---
          $retirante.empty().append('<option value="">Cargando...</option>');

          if (centroId) {
            // Cargar empleados asociados al centro
            $.ajax({
              url: '{% url "obtener_empleados_por_centro" %}',
              data: { centro_id: centroId },
              success: function (data) {
                $retirante.empty().append('<option value="">Seleccione un retirante...</option>');
                data.empleados.forEach(emp => {
                  const label = `${emp.legajo}, ${emp.nombre}`;
                  $retirante.append(new Option(label, emp.id));
                });
              },
              error: function () {
                $retirante.empty().append('<option value="">Error al cargar empleados</option>');
              }
            });

            // habilitar productos
            $productos.prop('disabled', false);

          } else {
            $retirante.empty().append('<option value="">Seleccione un centro primero</option>');
            $productos.val(null).trigger('change');
            $productos.prop('disabled', true);
          }
        });

        // === 2. Productos din√°micos seg√∫n centro de costo y tipo de entrega ===
        $productos.select2({
          placeholder: 'Buscar producto...',
          ajax: {
            url: '{% url "buscar_productos_por_centro" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
              return {
                q: params.term,
                centro_costo: $centro.val(),   // üëà centro seleccionado
                tipo_entrega: $('#tipo_entrega').val() // üëà nuevo select para EPP o insumos
              };
            },
            processResults: function (data) {
              return { results: data.results };
            },
            cache: true
          },
          minimumInputLength: 0
        });

        // üîÑ refrescar productos cuando cambie el tipo_entrega
        $('#tipo_entrega').on('change', function () {
          $productos.val(null).trigger('change'); // limpia selecci√≥n
        });

      });

      function bloquearSelects() {
        const centroSelect = document.getElementById("centro_costos");
        const retiranteSelect = document.getElementById("retirante");

        // pasar valores a los hidden
        document.getElementById("hidden_centro_costos").value = centroSelect.value;
        document.getElementById("hidden_retirante").value = retiranteSelect.value;

        // quitar name para que no se manden duplicados
        centroSelect.removeAttribute("name");
        retiranteSelect.removeAttribute("name");

        // bloquear selects
        centroSelect.disabled = true;
        retiranteSelect.disabled = true;
      }

      function desbloquearSelects() {
        const centro = document.getElementById("centro_costos");
        const retirante = document.getElementById("retirante");

        // volver a poner los name
        centro.setAttribute("name", "centro_costos");
        retirante.setAttribute("name", "retirante");

        // desbloquear
        centro.disabled = false;
        retirante.disabled = false;

        // limpiar los hidden
        document.getElementById("hidden_centro_costos").value = "";
        document.getElementById("hidden_retirante").value = "";
      }

      function bloquearTipoSeleccion() {
        const tipoEntregaSelect = document.getElementById("tipo_entrega");
        const tipoFacturacionSelect = document.getElementById("tipo_facturacion");

        // Pasar valores a los hidden
        document.getElementById("hidden_tipo_entrega").value = tipoEntregaSelect.value;
        document.getElementById("hidden_tipo_facturacion").value = tipoFacturacionSelect.value;

        // Quitar name y deshabilitar los selects
        tipoEntregaSelect.removeAttribute("name");
        tipoEntregaSelect.disabled = true;
        tipoFacturacionSelect.removeAttribute("name");
        tipoFacturacionSelect.disabled = true;
      }

      function desbloquearTipoSeleccion() {
        const tipoEntregaSelect = document.getElementById("tipo_entrega");
        const tipoFacturacionSelect = document.getElementById("tipo_facturacion");

        // Volver a poner los name originales (si se modific√≥ el HTML como se sugiri√≥)
        tipoEntregaSelect.setAttribute("name", "tipo_entrega_select");
        tipoFacturacionSelect.setAttribute("name", "tipo_facturacion_select");

        // Desbloquear
        tipoEntregaSelect.disabled = false;
        tipoFacturacionSelect.disabled = false;

        // Limpiar los hidden
        document.getElementById("hidden_tipo_entrega").value = "";
        document.getElementById("hidden_tipo_facturacion").value = "";
      }

      function agregarProductoDesdeSelect() {
        const centroId = $('#centro_costos').val();
        const select = $('#select-producto');
        const productoId = select.val();
        const productoDesc = select.find("option:selected").text();
        const cantidad = $('#cantidad-producto').val();

        if (!centroId) {
          alert('Deb√©s seleccionar un centro de costo antes de elegir materiales.');
          return;
        }

        if (!productoId || !cantidad || cantidad <= 0) {
          alert('Deb√©s seleccionar un producto y una cantidad v√°lida.');
          return;
        }

        if (document.getElementById(`fila_${productoId}`)) {
          alert('Este producto ya fue agregado.');
          return;
        }

        const fila = `
      <tr id="fila_${productoId}">
        <td class="p-2">${productoDesc}</td>
        <td class="p-2 text-center">${cantidad}</td>
        <td class="p-2 text-center">
          <input type="hidden" name="producto_${productoId}" value="${cantidad}">
          <button type="button" onclick="eliminarProducto('${productoId}')" class="text-red-600 hover:underline">Eliminar</button>
        </td>
      </tr>
    `;

        document.querySelector('#tabla-productos tbody').insertAdjacentHTML('beforeend', fila);
        showSuccessToast("Producto agregado correctamente ‚úÖ", "success");

        bloquearSelects();
        bloquearTipoSeleccion();

        $('#select-producto').val(null).trigger('change');
        $('#cantidad-producto').val('');
      }

      function eliminarProducto(id) {
        showSuccessToast("Producto eliminado correctamente ‚úÖ", "success");
        document.getElementById(`fila_${id}`).remove();

        if (document.querySelectorAll('#tabla-productos tbody tr').length === 0) {
          desbloquearSelects();
          desbloquearTipoSeleccion();
        }
      }
    </script>

    <script>
      function showSuccessToast(message, type = "success") {
        const container = document.getElementById("toast-container");

        // Crear div del toast
        const toast = document.createElement("div");
        toast.className = `px-8 py-4 rounded-lg shadow-lg text-white 
    ${type === "success" ? "bg-green-600" : "bg-red-600"} 
    animate-fadeIn`;

        toast.innerText = message;

        container.appendChild(toast);

        // Desaparecer despu√©s de 3s
        setTimeout(() => {
          toast.classList.add("animate-fadeOut");
          setTimeout(() => toast.remove(), 500);
        }, 3000);
      }

      function showErrorToast(message, type = "error") {
        const container = document.getElementById("toast-container");

        // Crear div del toast  
        const toast = document.createElement("div");
        toast.className = `px-8 py-4 rounded-lg shadow-lg text-white 
    ${type === "success" ? "bg-red-600" : "bg-red-600"}
    animate-fadeIn`;

        toast.innerText = message;

        container.appendChild(toast);

        // Desaparecer despu√©s de 3s
        setTimeout(() => {
          toast.classList.add("animate-fadeOut");
          setTimeout(() => toast.remove(), 500);
        }, 3000);
      }
    </script>

    <script>
      $(document).ready(function () {
        console.log("‚úÖ DOM y jQuery listos");

        let $retiranteSelect = $("#retirante");
        let $tagsList = $("#tags_list");
        let $tipoEntrega = $("#tipo_entrega");  // üëà select de tipo de entrega

        if ($retiranteSelect.length === 0) {
          console.error("‚ùå No se encontr√≥ #id_retirante en el DOM");
          return;
        }
        if ($tagsList.length === 0) {
          console.error("‚ùå No se encontr√≥ #tags_list en el DOM");
          return;
        }

        $retiranteSelect.on("select2:select", function (e) {
          let empleadoId = $(this).val();
          let tipoEntrega = $tipoEntrega.val();

          console.log("üë§ Retirante seleccionado:", empleadoId);
          console.log("üì¶ Tipo de entrega actual:", tipoEntrega);

          // üëá Solo si es EPP se buscan y muestran tags
          if (tipoEntrega !== "EPP") {
            console.log("‚ö†Ô∏è No es EPP, se ignoran tags");
            $tagsList.empty();  // limpiar lista
            return;
          }

          if (!empleadoId) {
            $tagsList.html("<li class='text-gray-400'>Sin seleccion</li>");
            return;
          }

          let url = `/get_tags/${empleadoId}/`;
          console.log("üåê Fetch a:", url);

          fetch(url)
            .then(response => response.json())
            .then(data => {
              console.log("üì¶ Datos JSON recibidos:", data);
              $tagsList.empty();

              if (data.length === 0) {
                $tagsList.html("<span class='text-gray-400 text-sm'>No tiene tags asociados</span>");
              } else {
                data.forEach(tag => {
                  $tagsList.append(`
                          <span class="px-3 py-1 rounded-full bg-blue-300 text-blue-800 text-sm font-medium shadow-sm">
                            ${tag.descripcion}
                          </span>
                      `);
                });
              }
            })
            .catch(err => console.error("‚ùå Error en fetch:", err));
        });
      });

    </script>



    {% endblock %}

</body>

{% endblock %}