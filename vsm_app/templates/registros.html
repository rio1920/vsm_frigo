{% extends 'base.html' %}
{% load static %} {% load permisos_tags %}
{% block title %}Registros de VSM - VSM{% endblock %}
{% block content %}

{% include 'navbar.html' %}

<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-base-300 p-6 rounded-xl shadow-xl w-96">
      <h2 class="text-xl font-semibold mb-3">¿Eliminar VSM?</h2>
      <p class="mb-5">
            Esta acción enviará la reversa a SAP y eliminará el registro de la aplicación.
      </p>

      <div class="flex justify-end gap-3">
          <button onclick="closeDeleteModal()" class="btn btn-secondary text-base-100">Cancelar</button>
          <button id="confirmDeleteBtn" class="btn btn-error text-base-100">Eliminar</button>
      </div>
  </div>
</div>

{% if error %}
<div class="alert alert-error max-w-6xl mx-auto my-4">
  <div>
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>{{ error }}</span>
  </div>
</div>
{% endif %}

<body class="bg-[var(--fondo-oscuro)]">
  <h1 id="titulo" class="text-3xl font-bold mb-6 text-center mt-18" style="color: var(--detalle-dorado); margin-top: 18px;">
    Historial de Vales de Salida de Materiales (VSM)
  </h1>

  <div class="max-w-6xl mx-auto px-4">
    <div class="filtros m-4 w-11/12 max-w-6xl">
        <form method="get" class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
            
            <input type="text" name="solicitante" placeholder="Solicitante"
                value="{{ filtros.solicitante }}" 
                class="p-2 rounded bg-base-200 border border-gray-700 w-full md:w-auto">
            
            <input type="text" name="retirante" placeholder="Retirante"
                value="{{ filtros.retirante }}"
                class="p-2 rounded bg-base-200 border border-gray-700 w-full md:w-auto">
            
            <input type="text" name="cc" placeholder="CC"
                value="{{ filtros.cc }}"
                class="p-2 rounded bg-base-200 border border-gray-700 w-full md:w-auto">

            <select name="estado" class="p-2 rounded bg-base-200 border border-gray-700 w-full md:w-auto">
                <option value="pendiente" {% if request.GET.estado == "pendiente" or not request.GET.estado %}selected{% endif %}>Pendiente</option>
                <option value="entregado" {% if request.GET.estado == "entregado" %}selected{% endif %}>Entregado</option>
                <option value="#" {% if request.GET.estado == "#" %}selected{% endif %}>Todos</option>
            </select>
            
            <button type="submit" class="btn px-4 py-2 rounded btn-primary w-full md:w-auto">Filtrar</button>
        </form>
    </div>
  </div>

  <div class="overflow-x-auto rounded-lg shadow-lg max-w-6xl mx-auto bg-base-200">
    <table class="min-w-full divide-y divide-gray-700 bg-[var(--bg-secondary)]">
      <thead>
        <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold">ID VSM</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Solicitante</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Fecha Solicitud</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Estado</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Tipo Facturacion</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Tipo Entrega</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-700" style="overflow: hidden;">
        {% for registro in registros %}
        <tr class="cursor-pointer hover:bg-base-200 transition" style="overflow: hidden;">
            <td class="px-4 py-3">{{ registro.id }}</td>
            <td class="px-4 py-3">{{ registro.solicitante }}</td>
            <td class="px-4 py-3">{{ registro.fecha_solicitud|date:"d/m/y H:m" }}</td>
            <td class="px-4 py-3">
              {% if registro.estado == 'entregado' %}
                
                <span class="badge badge-success text-black" style="border: 1px solid green; text-transform: uppercase;">{{ registro.estado }}</span>

              {% elif registro.estado == 'pendiente' %}

                <span class="badge badge-warning text-black" style="border: 1px solid yellow; text-transform: uppercase;">{{ registro.estado }}</span>

              {% elif registro.estado == 'rechazado' %}

                <span class="badge badge-error text-black" style="border: 1px solid red; text-transform: uppercase;">{{ registro.estado }}</span>
              {% else %}

                <span class="text-white-500 font-semibold">{{ registro.estado }}</span>
              
              {% endif %}
            </td>
            {% if registro.tipo_facturacion == 'FACTURADO' %}
            <td class="px-4 py-3"> Facturado </td>
            {% elif registro.tipo_facturacion == 'NO_FACTURADO' %}
            <td class="px-4 py-3"> No Facturado </td>
            {% endif %}
            <td class="px-4 py-3">{{ registro.tipo_entrega }}</td>
            <td class="px-4 py-3 text-center">
              {% if registro.estado == 'pendiente' and registro.tipo_entrega == 'INSUMOS' %}
              <a href="{% url 'ver_pendiente' registro.id %}" class="btn btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-list" viewBox="0 0 16 16">
                  <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/>
                  <path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8m0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0M4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
                </svg>
              </a>
              {% elif registro.estado == 'pendiente' and registro.tipo_entrega == 'EPP' %}
              <a href="{% url 'ver_pendiente' registro.id %}" class="btn btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-list" viewBox="0 0 16 16">
                  <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/>
                  <path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8m0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0M4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
                </svg>
              </a>
              {% endif %}
                {% if user|has_perm:"facturado_can_edit" and registro.estado == 'pendiente' %}
              <button onclick="openDeleteModal({{ registro.id }})" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
              </button>
                {% endif %}
                {% if user|has_perm:"facturado_can_delete" and registro.estado == 'pendiente' %}
              <a href="#" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
              </a>
                {% endif %}
                {% if registro.estado == 'entregado' and registro.tipo_entrega == 'EPP' %}
              <a href="{% url 'generar_template_epp' registro.id %}" target="_blank" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                  <path d="M8 3c-3.5 0-6.5 2.5-7.5 6 1 3.5 4 6 7.5 6s6.5-2.5 7.5-6c-1-3.5-4-6-7.5-6zm0 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
                  <path d="M8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
                </svg>  
              </a>
              <button onclick="openDeleteModal({{ registro.id }})" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
              </button>
                {% elif registro.estado == 'entregado' and registro.tipo_entrega == 'INSUMOS' %}
              <a href="{% url 'generar_template_insumo' registro.id %}" target="_blank" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                  <path d="M8 3c-3.5 0-6.5 2.5-7.5 6 1 3.5 4 6 7.5 6s6.5-2.5 7.5-6c-1-3.5-4-6-7.5-6zm0 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
                  <path d="M8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
                </svg>
              </a>
              <button onclick="openDeleteModal({{ registro.id }})" class="btn px-2 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
              </button>
                {% endif %}
            </td>
        </tr>
        <tr>

        <tr id="detail-{{ forloop.counter }}" class="hidden">
          <td colspan="8" class="p-0">
            <div class="overflow-hidden transition-all duration-300 ease-in-out scale-y-0 origin-top bg-base-200 px-6 py-4 text-sm text-gray-300 fit-con" id="detail-content-{{ forloop.counter }}">
              <strong>Detalles</strong><br/>
              {{ registro.observaciones }}<br/>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      {% if not registros %}
      <tbody class="divide-y divide-gray-700">    
        <tr>
          <td colspan="6" class="px-4 py-3 text-center text-gray-500">
            No hay registros de VSM disponibles.
          </td>
        </tr>
      </tbody>
        {% endif %}
    </table>
  </div>

  {% include 'paginator.html' %}

  {% if messages %}
  <div id="toast-container" class="fixed top-4 right-4 z-50">
    {% for message in messages %}
      <div class="mb-2 px-4 py-2 rounded-lg shadow-lg text-white
                  {% if message.tags == 'success' %} bg-green-600 {% elif message.tags == 'error' %} bg-red-600 {% else %} bg-gray-600 {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>

  <script>
    setTimeout(() => {
      const toast = document.getElementById("toast-container");
      if (toast) toast.style.display = "none";
    }, 3000);
  </script>
  {% endif %}   
  


<script>
document.addEventListener("DOMContentLoaded", function() {

    const modal = document.getElementById("deleteModal");
    const confirmBtn = document.getElementById("confirmDeleteBtn");

    if (!modal || !confirmBtn) {
        console.warn("⚠️ Modal de eliminación no encontrado en esta página.");
        return;
    }

    let selectedVSM = null;

    window.openDeleteModal = function(vsmId) {
        modal.classList.remove("hidden");
    };

    window.closeDeleteModal = function() {
        modal.classList.add("hidden");
    };

    confirmBtn.onclick = function() {
        if (!selectedVSM) return;

        fetch(`/vsm/${selectedVSM}/eliminar/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then((res) => res.json())
        .then((data) => {
            if (data.success) {
                window.closeDeleteModal();
                location.reload();
            } else {
                alert("Error al eliminar el VSM");
            }
        });
    };

});
</script>

</body>
{% endblock %}